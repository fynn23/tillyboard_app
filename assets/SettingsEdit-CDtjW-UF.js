import{_ as L,D as r,c as u,o as c,H as i,b as m,J as b,j as V,F as y,a as p,t as C,G as f,n as k,N as P,d as S}from"./main-BsligTLj.js";const I={props:{plugin:{type:Object,required:!0},settings:{type:Object,required:!0}},emits:["update:settings"],data(){return{projects:[],isLoading:!1,isComingUp:!1,showSettings:!1,showDbPass:!1,selectMode:"select",newProject:{name:"",region:"us-east-1",organizationId:"",dbPass:""},organizations:[]}},watch:{async selectMode(e){var t;e==="create"&&(this.organizations=await this.fetchOrganizations(),this.newProject={name:"WeWeb - "+wwLib.$store.getters["websiteData/getDesignInfo"].name,region:"us-east-1",organizationId:(t=this.organizations[0])==null?void 0:t.id,dbPass:wwLib.wwUtils.getUid()})}},computed:{projectRef(){var e,t,o;return(o=(t=(e=this.settings)==null?void 0:e.publicData)==null?void 0:t.projectUrl)==null?void 0:o.replace("https://","").replace(".supabase.co","")},projectsOptions(){return this.projects.map(e=>({label:`${e.name} (${e.id}) ${e.status==="INACTIVE"?"#PAUSED":""}`,value:`https://${e.id}.supabase.co`}))},isConnected(){return this.settings.privateData.accessToken}},mounted(){this.isConnected?this.refreshProjects():this.showSettings=!0;const e=this.settings.publicData.projectUrl&&this.settings.publicData.apiKey,t=wwLib.wwPlugins.supabase&&wwLib.wwPlugins.supabase.settings.publicData.projectUrl&&wwLib.wwPlugins.supabase.settings.publicData.apiKey;!e&&t&&this.$emit("update:settings",{...this.settings,publicData:{...this.settings.publicData,apiKey:wwLib.wwPlugins.supabase.settings.publicData.apiKey,projectUrl:wwLib.wwPlugins.supabase.settings.publicData.projectUrl},privateData:{...this.settings.privateData,accessToken:wwLib.wwPlugins.supabase.settings.privateData.accessToken,apiKey:this.settings.privateData.apiKey||wwLib.wwPlugins.supabase.settings.privateData.apiKey,databasePassword:wwLib.wwPlugins.supabase.settings.privateData.databasePassword,connectionString:wwLib.wwPlugins.supabase.settings.privateData.connectionString}})},methods:{async changeProjectUrl(e){let t=this.settings.publicData.apiKey,o=this.settings.privateData.apiKey,h=this.settings.privateData.connectionString;if(this.isConnected){const{apiKeys:s,pgbouncer:a}=await this.fetchProject(e.replace("https://","").replace(".supabase.co",""));t=s.find(d=>d.name==="anon").api_key,o=s.find(d=>d.name==="service_role").api_key,h=a.connection_string}this.$emit("update:settings",{...this.settings,publicData:{...this.settings.publicData,projectUrl:e,apiKey:t},privateData:{...this.settings.privateData,apiKey:o,connectionString:h}})},changeCustomDomain(e){this.$emit("update:settings",{...this.settings,publicData:{...this.settings.publicData,customDomain:e}})},changePublicApiKey(e){this.$emit("update:settings",{...this.settings,publicData:{...this.settings.publicData,apiKey:e}})},changePrivateApiKey(e){this.$emit("update:settings",{...this.settings,privateData:{...this.settings.privateData,apiKey:e}})},changeConnectionString(e){this.$emit("update:settings",{...this.settings,privateData:{...this.settings.privateData,connectionString:e}})},changeDatabasePassword(e){this.$emit("update:settings",{...this.settings,privateData:{...this.settings.privateData,databasePassword:e}})},async refreshProjects(){this.isLoading=!0;try{const{data:e}=await wwAxios.post(`${wwLib.wwApiRequests._getPluginsUrl()}/designs/${this.$store.getters["websiteData/getDesignInfo"].id}/supabase/projects/list`,{accessToken:this.settings.privateData.accessToken});this.projects=e==null?void 0:e.data,this.isLoading=!1}catch(e){throw this.isLoading=!1,e}},async fetchProject(e){this.isLoading=!0;try{const{data:t}=await wwAxios.get(`${wwLib.wwApiRequests._getPluginsUrl()}/designs/${this.$store.getters["websiteData/getDesignInfo"].id}/supabase/projects/${e}`);return this.isLoading=!1,t==null?void 0:t.data}catch(t){throw this.isLoading=!1,t}},async fetchOrganizations(){this.isLoading=!0;try{const{data:e}=await wwAxios.get(`${wwLib.wwApiRequests._getPluginsUrl()}/designs/${wwLib.$store.getters["websiteData/getDesignInfo"].id}/supabase/organizations`);return this.isLoading=!1,e==null?void 0:e.data}catch(e){throw this.isLoading=!1,e}},async createProject(){this.isLoading=!0;try{this.$emit("update:settings",{...this.settings,publicData:{...this.settings.publicData,projectUrl:"",apiKey:""},privateData:{...this.settings.privateData,apiKey:"",connectionString:"",databasePassword:""}});const{data:e}=await wwAxios.post(`${wwLib.wwApiRequests._getPluginsUrl()}/designs/${wwLib.$store.getters["websiteData/getDesignInfo"].id}/supabase/projects`,{name:this.newProject.name,organization_id:this.newProject.organizationId,region:this.newProject.region,db_pass:this.newProject.dbPass});this.isLoading=!1,this.isComingUp=!0;const t=e==null?void 0:e.data.id,o=`https://${e==null?void 0:e.data.id}.supabase.co`;let h=setInterval(async()=>{var s;if(await this.refreshProjects(),((s=this.projects.find(a=>a.id===(e==null?void 0:e.data.id)))==null?void 0:s.status)==="ACTIVE_HEALTHY"){clearInterval(h);const{apiKeys:a,pgbouncer:d}=await this.fetchProject(t),w=a.find(g=>g.name==="anon").api_key,D=a.find(g=>g.name==="service_role").api_key,v=d.connection_string,l=this.newProject.dbPass;this.$emit("update:settings",{...this.settings,publicData:{...this.settings.publicData,projectUrl:o,apiKey:w},privateData:{...this.settings.privateData,apiKey:D,connectionString:v,databasePassword:l}}),this.isComingUp=!1,this.selectMode="select"}},5e3)}catch(e){throw this.isLoading=!1,e}}}},K={key:0,class:"flex items-center"},E={class:"flex items-center"},R=["href"],A={class:"flex items-center"},q={key:0,class:"body-md flex items-center p-2"},x={class:"flex items-center"};function z(e,t,o,h,s,a){const d=r("wwEditorInputRadio"),w=r("wwEditorFormRow"),D=r("wwEditorInput"),v=r("wwEditorIcon"),l=r("wwEditorInputRow"),g=r("wwEditorInputText"),j=r("wwEditorQuestionMark"),U=r("wwLoaderSmall"),_=r("wwLoader");return c(),u(y,null,[i(w,{class:"w-100"},{default:b(()=>[a.isConnected?(c(),V(d,{key:0,modelValue:s.selectMode,"onUpdate:modelValue":t[0]||(t[0]=n=>s.selectMode=n),disabled:s.isComingUp,choices:[{label:"Select a project",value:"select"},{label:"Create a project",value:"create"}]},null,8,["modelValue","disabled"])):m("",!0)]),_:1}),s.selectMode==="select"||!a.isConnected?(c(),u(y,{key:0},[a.isConnected?(c(),u("div",K,[i(w,{required:"",label:"Project URL",class:"w-100"},{default:b(()=>[i(D,{type:"select",placeholder:"https://your-project.supabase.co","model-value":o.settings.publicData.projectUrl,options:a.projectsOptions,"onUpdate:modelValue":a.changeProjectUrl,class:"-full"},null,8,["model-value","options","onUpdate:modelValue"])]),_:1}),p("button",{type:"button",class:"ww-editor-button -primary -small -icon ml-2 mt-1",onClick:t[1]||(t[1]=(...n)=>a.refreshProjects&&a.refreshProjects(...n))},[i(v,{name:"refresh",medium:""})])])):m("",!0),a.isConnected?(c(),u("button",{key:1,onClick:t[2]||(t[2]=n=>s.showSettings=!s.showSettings),class:"ww-editor-button -secondary -small mb-2",type:"button"},C(s.showSettings?"Close":"Open")+" settings ",1)):m("",!0),s.showSettings||!a.isConnected?(c(),u(y,{key:2},[i(l,{label:"Project URL",type:"query",placeholder:"https://your-project.supabase.co","model-value":o.settings.publicData.projectUrl,"onUpdate:modelValue":a.changeProjectUrl},null,8,["model-value","onUpdate:modelValue"]),i(l,{label:"Custom Domain (optional)",type:"query",placeholder:"https://your-custom-domain.com","model-value":o.settings.publicData.customDomain,"onUpdate:modelValue":a.changeCustomDomain},null,8,["model-value","onUpdate:modelValue"]),i(l,{label:"Public API key",required:"",type:"query",placeholder:"ey********","model-value":o.settings.publicData.apiKey,"onUpdate:modelValue":e.changeApiKey},null,8,["model-value","onUpdate:modelValue"]),i(w,{label:"Service role key"},{default:b(()=>[p("div",E,[i(g,{type:"password",placeholder:"ey********",large:"",class:"w-full",style:{"-webkit-text-security":"disc"},"model-value":o.settings.privateData.apiKey,"onUpdate:modelValue":a.changePrivateApiKey},null,8,["model-value","onUpdate:modelValue"]),i(j,{"tooltip-position":"top-left","forced-content":"Required if you want to manage your users and roles from the Editor or restrict access to a page for a specific role.",class:k(["ml-2",{"text-yellow-500":!o.settings.privateData.apiKey}])},null,8,["class"])])]),_:1}),f(i(l,{label:"Connection string",type:"query",placeholder:"postgres://postgres.[YOUR-PROJECT-REF]:[YOUR-PASSWORD]@aws-0-eu-west-3.pooler.supabase.com:6543/postgres","model-value":o.settings.privateData.connectionString,"onUpdate:modelValue":a.changeConnectionString},null,8,["model-value","onUpdate:modelValue"]),[[P,!1]]),f(i(w,{label:"Database password"},{"append-label":b(()=>[p("a",{class:"ww-editor-link ml-2",href:`https://supabase.com/dashboard/project/${a.projectRef}/settings/database`,target:"_blank"}," Find it here ",8,R)]),default:b(()=>[p("div",A,[i(g,{type:"password",placeholder:"Enter your database password",style:{"-webkit-text-security":"disc"},large:"",tooltip:"Required if you want Copilot to be able to update your database.","model-value":o.settings.privateData.databasePassword,"onUpdate:modelValue":a.changeDatabasePassword,class:"w-full"},null,8,["model-value","onUpdate:modelValue"])])]),_:1},512),[[P,!1]])],64)):m("",!0)],64)):s.selectMode==="create"?(c(),u(y,{key:1},[s.isComingUp?(c(),u("div",q,[i(U,{loading:"",class:"mr-2"}),t[9]||(t[9]=p("div",null,"We're now preparing your database. Please wait a few moments, it may take up to 1 minute.",-1))])):(c(),u(y,{key:1},[i(l,{label:"Project name",type:"query",placeholder:"My new project",required:"",modelValue:s.newProject.name,"onUpdate:modelValue":t[3]||(t[3]=n=>s.newProject.name=n)},null,8,["modelValue"]),i(l,{label:"Organization",type:"select",placeholder:"Select an organization",required:"",modelValue:s.newProject.organizationId,"onUpdate:modelValue":t[4]||(t[4]=n=>s.newProject.organizationId=n),options:s.organizations.map(n=>({label:n.name,value:n.id}))},null,8,["modelValue","options"]),i(l,{label:"Hosting region",type:"select",placeholder:"us-east-1",required:"",modelValue:s.newProject.region,"onUpdate:modelValue":t[5]||(t[5]=n=>s.newProject.region=n),options:[{label:"us-east-1",value:"us-east-1"},{label:"us-east-2",value:"us-east-2"},{label:"us-west-1",value:"us-west-1"},{label:"us-west-2",value:"us-west-2"},{label:"ap-east-1",value:"ap-east-1"},{label:"ap-southeast-1",value:"ap-southeast-1"},{label:"ap-northeast-1",value:"ap-northeast-1"},{label:"ap-northeast-2",value:"ap-northeast-2"},{label:"ap-southeast-2",value:"ap-southeast-2"},{label:"eu-west-1",value:"eu-west-1"},{label:"eu-west-2",value:"eu-west-2"},{label:"eu-west-3",value:"eu-west-3"},{label:"eu-north-1",value:"eu-north-1"},{label:"eu-central-1",value:"eu-central-1"},{label:"eu-central-2",value:"eu-central-2"},{label:"ca-central-1",value:"ca-central-1"},{label:"ap-south-1",value:"ap-south-1"},{label:"sa-east-1",value:"sa-east-1"}]},null,8,["modelValue"]),i(w,{label:"Database password",required:""},{default:b(()=>[p("div",x,[i(g,{type:s.showDbPass?"text":"password",placeholder:"Enter your database password",style:S({"-webkit-text-security":s.showDbPass?"none":"disc"}),large:"",modelValue:s.newProject.dbPass,"onUpdate:modelValue":t[6]||(t[6]=n=>s.newProject.dbPass=n),class:"w-full"},null,8,["type","style","modelValue"]),p("button",{type:"button",class:"ww-editor-button -secondary -small -icon ml-2",onClick:t[7]||(t[7]=n=>s.showDbPass=!s.showDbPass)},[i(v,{name:s.showDbPass?"16/eye":"16/eye-off",medium:""},null,8,["name"])])])]),_:1}),p("button",{class:"ww-editor-button -primary",onClick:t[8]||(t[8]=(...n)=>a.createProject&&a.createProject(...n)),type:"button"},"Create project")],64))],64)):m("",!0),i(_,{loading:s.isLoading&&!s.isComingUp},null,8,["loading"])],64)}const T=L(I,[["render",z]]);export{T as default};
